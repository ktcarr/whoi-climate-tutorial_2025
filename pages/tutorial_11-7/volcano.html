
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Imports &#8212; WHOI Climate Data Tutorial (2025)</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'pages/tutorial_11-7/volcano';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="WHOI Climate Data Tutorial (2025) - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="WHOI Climate Data Tutorial (2025) - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../setup/setup.html">Setup</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../setup/setup_venv.html">Python / virtual environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup/connect_to_server.html">Accessing the CMIP data servers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup/test.html">Test the setup worked!</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial_9-19/overview.html">9/19 tutorial</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1DZRXfNPGTo16g4iyo0TyZzevw06dgi5qklZvJoqnEQw/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial_9-19/example.html">Example: Woods Hole temperature variability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial_9-19/hw1_starter.html">Assignment 1 template</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial_10-10/overview.html">10/10 tutorial</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/18Rp-7hCtp8fYvdGVZOlwaS4b_-PtmIVTkmM529wNN1Q/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial_10-10/ENSO_example.html">ENSO example</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="overview.html">11/7 tutorial</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1bAFB9mO22WYc6El3nojJgDyJqpis6xx5XXz0Tj2rMbI/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="azores_prep.html">Azores high: data prep</a></li>
<li class="toctree-l2"><a class="reference internal" href="azores_analysis_tutorial.html">Azores high: analysis</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../assignments/assignments_toc.html">Assignments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../assignments/assignment1.html">Assignment 1: model validation</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../resources/resources.html">Resources</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../resources/FAQ.html">FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources/xarray_reference.html">Xarray reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources/git_basics.html">Git basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources/eofs.html">Intro to EOFs</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ktcarr/whoi-climate-tutorial_2025" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ktcarr/whoi-climate-tutorial_2025/issues/new?title=Issue%20on%20page%20%2Fpages/tutorial_11-7/volcano.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/pages/tutorial_11-7/volcano.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Imports</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Imports</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-fns">Helper fns</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-trim-save-data">Load, trim, save data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-data-sample">plot data sample</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#timeseries">timeseries</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="imports">
<h1>Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cmocean</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpatches</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mticker</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1">## (optional) remove gridlines from plots</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;axes.facecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;axes.grid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="helper-fns">
<h1>Helper fns<a class="headerlink" href="#helper-fns" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_setup</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a subplot to the figure with the given map projection</span>
<span class="sd">    and lon/lat range. Returns an Axes object.&quot;&quot;&quot;</span>

    <span class="c1">## increase resolution for projection</span>
    <span class="c1">## (otherwise lines plotted on surface won&#39;t follow curved trajectories)</span>
    <span class="n">projection</span><span class="o">.</span><span class="n">threshold</span> <span class="o">/=</span> <span class="mi">1000</span>

    <span class="c1">## Create subplot with given projection</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>

    <span class="c1">## Subset to given region</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">lon_range</span><span class="p">,</span> <span class="o">*</span><span class="n">lat_range</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

    <span class="c1">## draw coastlines</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1">## add tick labels</span>
    <span class="k">if</span> <span class="n">xticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1">## add lon/lat labels</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span>
            <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1">## specify which axes to label</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">## specify ticks</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">ylocator</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">xlocator</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_box_outline</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot box outlining the specifed lon/lat range on given</span>
<span class="sd">    ax object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## get width and height</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">lat_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lat_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">lon_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lon_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">## add rectangle to plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
        <span class="n">mpatches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">[</span><span class="n">lon_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lat_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_correlation</span><span class="p">(</span><span class="n">plot_setup_fn</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make spatial plot of correlation, using the specified</span>
<span class="sd">    plot setup function and pre-computed correlation.</span>
<span class="sd">    Args:</span>
<span class="sd">        - plot_setup_fn: function that returns a fig, ax object</span>
<span class="sd">        - corr: xarray with spatial correlation</span>
<span class="sd">        - x, y: lon/lat points for plotting</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## blank canvas to plot on</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="c1">## draw background map of Atlantic</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_setup_fn</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="c1">## plot the data</span>
    <span class="n">plot_data</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="p">,</span>
        <span class="n">corr</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
        <span class="n">levels</span><span class="o">=</span><span class="n">make_cb_range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;cmo.balance&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">## create colorbath</span>
    <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Corr.&quot;</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_setup_pacific</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot Atlantic region&quot;&quot;&quot;</span>

    <span class="c1">## adjust figure size</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1">## specify map projection</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=-</span><span class="mi">160</span><span class="p">)</span>

    <span class="c1">## get ax object</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_setup</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span>
        <span class="n">proj</span><span class="p">,</span>
        <span class="n">lon_range</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
        <span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
        <span class="n">xticks</span><span class="o">=</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">160</span><span class="p">,</span> <span class="o">-</span><span class="mi">110</span><span class="p">],</span>
        <span class="n">yticks</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_cb_range</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make colorbar_range for cmo.balance</span>
<span class="sd">    Args:</span>
<span class="sd">        - &#39;amp&#39;: amplitude of maximum value for colorbar</span>
<span class="sd">        - &#39;delta&#39;: increment for colorbar</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">amp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">amp</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span> <span class="n">delta</span><span class="p">)]</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_setup_timeseries</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create fig, ax objects and label time axis</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## set up plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="c1">## restrict to last 50 years and label axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span><span class="p">])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1979</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_seasonal_cycle</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the seasonal cycle (monthly mean ± 1 standard dev.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="c1">## mean</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">mean</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\mu$&quot;</span><span class="p">)</span>

    <span class="c1">## mean ± std</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">std</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\mu \pm \sigma$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">mean</span> <span class="o">-</span> <span class="n">std</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1">## label</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>


<span class="k">def</span><span class="w"> </span><span class="nf">spatial_avg</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;function to compute spatial average of data on grid with constant</span>
<span class="sd">    longitude/latitude spacing.&quot;&quot;&quot;</span>

    <span class="c1">## first, compute cosine of latitude (after converting degrees to radians)</span>
    <span class="n">latitude_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>
    <span class="n">cos_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">latitude_radians</span><span class="p">)</span>

    <span class="c1">## get weighted average using xarray</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">cos_lat</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">avg</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_trend_coefs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get coefficients for trend&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)[</span><span class="s2">&quot;polyfit_coefficients&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_trend</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get trend for an xr.dataarray along specified dimension,\n&quot;,</span>
<span class="sd">    by fitting polynomial of degree &#39;deg&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## get \&quot;time index\&quot;, used to avoid numerical issues when curve fitting\n&quot;,</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time_idx</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">))))</span>
    
    <span class="c1">## Get coefficients for best fit</span>
    <span class="n">polyfit_coefs</span> <span class="o">=</span> <span class="n">get_trend_coefs</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time_idx&quot;</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="c1">## Get best fit line (linear trend in this case)\n&quot;,</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;time_idx&quot;</span><span class="p">],</span> <span class="n">polyfit_coefs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trend</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;time_idx&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">detrend</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove trend of degree &#39;deg&#39; from data, along dimension &#39;dim&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">data</span> <span class="o">-</span> <span class="n">get_trend</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_empirical_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the &quot;empirical&quot; probability distribution function for the data x.</span>
<span class="sd">    In this case the result is a normalized histogram,</span>
<span class="sd">    Normalized means that integrating over the histogram yields 1.</span>
<span class="sd">    Returns the PDF (normalized histogram) and edges of the histogram bins</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## compute histogram</span>
    <span class="k">if</span> <span class="n">bin_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>

    <span class="c1">## normalize to a probability distribution (PDF)</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">hist</span> <span class="o">/</span> <span class="p">(</span><span class="n">hist</span> <span class="o">*</span> <span class="n">bin_width</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">bin_edges</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_gaussian_best_fit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get gaussian best fit to data, and evaluate</span>
<span class="sd">    probabilities over the range of the data.&quot;&quot;&quot;</span>

    <span class="c1">## get normal distribution best fit</span>
    <span class="n">gaussian</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">scale</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

    <span class="c1">## evaluate over range of data</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="n">x_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">amp</span><span class="p">,</span> <span class="n">amp</span><span class="p">)</span>
    <span class="n">pdf_eval</span> <span class="o">=</span> <span class="n">gaussian</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_eval</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pdf_eval</span><span class="p">,</span> <span class="n">x_eval</span>


<span class="k">def</span><span class="w"> </span><span class="nf">swap_longitude_range</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;swap longitude range of xr.DataArray from [0,360) to (-180, 180]&quot;&quot;&quot;</span>

    <span class="c1">## copy of longitude coordinate to be modified</span>
    <span class="n">new_longitude</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1">## find index where longitude first exceeds 180.</span>
    <span class="c1">## (note: np.argmax returns first instance of &quot;True&quot; in boolean array)</span>
    <span class="n">swap_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">new_longitude</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span>

    <span class="c1">## relabel values &gt;180</span>
    <span class="n">new_longitude</span><span class="p">[</span><span class="n">swap_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">360</span> <span class="o">+</span> <span class="n">new_longitude</span><span class="p">[</span><span class="n">swap_idx</span><span class="p">:]</span>

    <span class="c1">## add this coordinate back to the array</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_longitude</span>

    <span class="c1">## &quot;roll&quot; the data to be centered at zero</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">roll</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">swap_idx</span><span class="p">},</span> <span class="n">roll_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_autocorr_helper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get autocorrelation of data for single lag&quot;&quot;&quot;</span>

    <span class="c1">## return 1 for a lag of 0</span>
    <span class="k">if</span> <span class="n">lag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="c1">## get lagged version of x</span>
    <span class="k">elif</span> <span class="n">lag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x_lagged</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lag</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">x_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">lag</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_lagged</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">lag</span><span class="p">))</span>
        <span class="n">x_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="n">lag</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1">## re-label time axis so arrays match</span>
    <span class="n">x_lagged</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_</span><span class="o">.</span><span class="n">time</span>

    <span class="c1">## subset for data from given month</span>
    <span class="k">if</span> <span class="n">month</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">is_month</span> <span class="o">=</span> <span class="n">x_</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span>
        <span class="n">x_</span> <span class="o">=</span> <span class="n">x_</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">is_month</span><span class="p">)</span>
        <span class="n">x_lagged</span> <span class="o">=</span> <span class="n">x_lagged</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">is_month</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">get_corr_coef</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">x_lagged</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_autocorr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lags</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get autocorrelation for data for multiple lags&quot;&quot;&quot;</span>

    <span class="c1">## put autocorrelation for each lag in array</span>
    <span class="n">autocorr</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_autocorr_helper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">]</span>

    <span class="c1">## convert to xr.DataArray</span>
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">autocorr</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lag&quot;</span><span class="p">:</span> <span class="n">lags</span><span class="p">})</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_autocorr_by_month</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get autocorrelation for each month, and stack in array&quot;&quot;&quot;</span>

    <span class="c1">## compute autocorrelation for each month</span>
    <span class="n">autocorr</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_autocorr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lags</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)]</span>

    <span class="c1">## convert to xarray</span>
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">autocorr</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_simulation</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">member_id</span><span class="p">,</span> <span class="n">simulation_type</span><span class="p">,</span> <span class="n">preprocess_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_jetstream</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load dataset for single simulation, for single variable.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        - varname: name of variable to load, one of {&quot;SST&quot;,&quot;PSL&quot;}</span>
<span class="sd">        - member_id: ID of ensemble member to load, an integer in the range [1,10]</span>
<span class="sd">        - simulation_type: one of {&quot;hist&quot;, &quot;rcp85&quot;}</span>
<span class="sd">        - preprocess func: optional preprocessing function to apply to the simulation</span>
<span class="sd">    Returns:</span>
<span class="sd">        - xarray dataarray with given data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Filepath to the CESM LENS dataset</span>
    <span class="k">if</span> <span class="n">use_jetstream</span><span class="p">:</span>
        <span class="n">lens_fp</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;jetstream/climate/data1/yokwon/CESM1_LE/downloaded/ocn/proc/tseries/monthly&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">lens_fp</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;cmip6/data/cmip6/CMIP/NCAR/LENS&quot;</span><span class="p">)</span>

    <span class="c1">#### 1. get filepath to data</span>
    <span class="n">data_fp</span> <span class="o">=</span> <span class="n">SERVER_FP</span> <span class="o">/</span> <span class="n">lens_fp</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>

    <span class="c1">#### 2. get naming pattern for files to open</span>
    <span class="k">if</span> <span class="n">simulation_type</span> <span class="o">==</span> <span class="s2">&quot;hist&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_jetstream</span><span class="p">:</span>
            <span class="n">file_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;*B20TRC5CNBDRD*g16.</span><span class="si">{</span><span class="n">member_id</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">*.nc&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;*20TRC*.</span><span class="si">{</span><span class="n">member_id</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">.*.nc&quot;</span>

    <span class="k">elif</span> <span class="n">simulation_type</span> <span class="o">==</span> <span class="s2">&quot;rcp85&quot;</span><span class="p">:</span>
        <span class="n">file_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;*RCP85*.</span><span class="si">{</span><span class="n">member_id</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">.*.nc&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not a valid simulation type&quot;</span><span class="p">)</span>

    <span class="c1">#### 3. open the relevant datasets, applying preprocessing function</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span>
        <span class="n">paths</span><span class="o">=</span><span class="n">data_fp</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_pattern</span><span class="p">),</span>
        <span class="n">preprocess</span><span class="o">=</span><span class="n">preprocess_func</span><span class="p">,</span>
        <span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">[[</span><span class="n">varname</span><span class="p">,</span><span class="s2">&quot;TAREA&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_ensemble_helper</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">simulation_type</span><span class="p">,</span> <span class="n">preprocess_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load all ensemble members for given simulation type and variable.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        - varname: name of variable to load, one of {&quot;SST&quot;,&quot;PSL&quot;}</span>
<span class="sd">        - simulation_type: one of {&quot;hist&quot;, &quot;rcp85&quot;}</span>
<span class="sd">        - preprocess func: optional preprocessing function to apply to the simulation</span>
<span class="sd">    Returns:</span>
<span class="sd">        - xarray dataarray with given data and &#39;ensemble&#39; dimension</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## put arguments in dictionary</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">varname</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span>
        <span class="n">simulation_type</span><span class="o">=</span><span class="n">simulation_type</span><span class="p">,</span>
        <span class="n">preprocess_func</span><span class="o">=</span><span class="n">preprocess_func</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">## put results in list</span>
    <span class="n">member_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">36</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span><span class="mi">108</span><span class="p">)])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_simulation</span><span class="p">(</span><span class="n">member_id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">member_ids</span><span class="p">]</span>

    <span class="c1">## concatenate data along the &quot;ensemble&quot; dimension</span>
    <span class="n">ensemble_dim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">43</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;member&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">ensemble_dim</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_ensemble</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">simulation_type</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">,</span> <span class="n">preprocess_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_fp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load all ensemble members for given simulation type and variable.</span>
<span class="sd">    (Checks if data exists locally first).</span>
<span class="sd">    Arguments:</span>
<span class="sd">        - varname: name of variable to load, one of {&quot;SST&quot;,&quot;PSL&quot;}</span>
<span class="sd">        - simulation_type: one of {&quot;hist&quot;, &quot;rcp85&quot;}</span>
<span class="sd">        - preprocess func: optional preprocessing function to apply to the simulation</span>
<span class="sd">        - save_fp: pathlib.Path object (save the result here if specified)</span>
<span class="sd">    Returns:</span>
<span class="sd">        - xarray dataarray with given data and &#39;ensemble&#39; dimension</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## define preprocessing function which trims to specified latitude range</span>
    <span class="n">preprocess_func_helper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">preprocess_func</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lat_range</span><span class="o">=</span><span class="n">lat_range</span><span class="p">)</span>

    <span class="c1">## put arguments in dictionary</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">varname</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span>
        <span class="n">simulation_type</span><span class="o">=</span><span class="n">simulation_type</span><span class="p">,</span>
        <span class="n">preprocess_func</span><span class="o">=</span><span class="n">preprocess_func_helper</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">## load pre-computed data if it exists</span>
    <span class="k">if</span> <span class="n">save_fp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1">## path to file</span>
        <span class="n">save_fp</span> <span class="o">=</span> <span class="n">save_fp</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">varname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">simulation_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lat_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">lat_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>

        <span class="c1">## check if file exists:</span>
        <span class="k">if</span> <span class="n">save_fp</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">save_fp</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1">## load the data and save to file for next time</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">load_ensemble_helper</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saving to file&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_fp</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="c1">## don&#39;t load/save the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_ensemble_helper</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocessing steps:</span>
<span class="sd">        1. remove data before Feb 1920</span>
<span class="sd">        2. trim in lon/lat space</span>
<span class="sd">        3. convert time dimension from cftime to datetime</span>

<span class="sd">        Note: assumes varname is &quot;SST&quot;!</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## trim in time</span>
    <span class="n">data_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s2">&quot;1920-02&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1">## trim in space</span>
    <span class="n">data_</span> <span class="o">=</span> <span class="n">trim</span><span class="p">(</span><span class="n">data_</span><span class="p">,</span> <span class="n">lat_range</span><span class="o">=</span><span class="n">lat_range</span><span class="p">)</span>

    <span class="c1">## update time dimension</span>
    <span class="n">start_year</span> <span class="o">=</span> <span class="n">data_</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">start_month</span> <span class="o">=</span> <span class="n">data_</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">start_month</span><span class="si">}</span><span class="s2">-01&quot;</span>
    <span class="n">data_</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span><span class="p">)</span>

    <span class="c1">## compute spatial average (weighted by grid cell area)</span>
    <span class="n">data_</span><span class="p">[</span><span class="s2">&quot;SST&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_</span><span class="p">[</span><span class="s2">&quot;SST&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">data_</span><span class="p">[</span><span class="s2">&quot;TAREA&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;nlat&quot;</span><span class="p">,</span><span class="s2">&quot;nlon&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">data_</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">swap_longitude_range_TLONG</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;swap longitude range of xr.DataArray from [0,360) to (-180, 180].</span>
<span class="sd">    Handles case with 2-dimension longitude coordinates (&#39;TLONG&#39;)&quot;&quot;&quot;</span>

    <span class="c1">## make copy of longitude coordinate to be modified</span>
    <span class="n">TLONG_new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">TLONG</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1">## relabel values greater than 180</span>
    <span class="n">exceeds_180</span> <span class="o">=</span> <span class="n">TLONG_new</span> <span class="o">&gt;</span> <span class="mi">180</span>
    <span class="n">TLONG_new</span><span class="p">[</span><span class="n">exceeds_180</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">360</span> <span class="o">+</span> <span class="n">TLONG_new</span><span class="p">[</span><span class="n">exceeds_180</span><span class="p">]</span>

    <span class="c1">## Update the coordinate on the xarray object</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TLONG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">TLONG_new</span>

    <span class="c1">## next, transpose data so that longitude is last dimension</span>
    <span class="c1">## (we&#39;ll do all the sorting along this dimension)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="s2">&quot;nlon&quot;</span><span class="p">)</span>

    <span class="c1">## Get indices needed to sort longitude to be monotonic increasing</span>
    <span class="n">TLONG_sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TLONG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">## sort the lon/lat coordindates</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TLONG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TLONG&quot;</span><span class="p">],</span> <span class="n">idx</span><span class="o">=</span><span class="n">TLONG_sort_idx</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TLAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TLAT&quot;</span><span class="p">],</span> <span class="n">idx</span><span class="o">=</span><span class="n">TLONG_sort_idx</span><span class="p">)</span>

    <span class="c1">#### sort the SST data</span>

    <span class="c1"># first, check to see if data has more than two dimensions</span>
    
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">extra_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">TLONG_sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">TLONG_sort_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">extra_dims</span><span class="p">)</span>
    
    <span class="c1">## now, do the actual sorting</span>
    <span class="n">data</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">TLONG_sort_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">trim</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">,</span> <span class="n">lon_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;select part of data in given longitude/latitude range&quot;&quot;&quot;</span>

    <span class="c1">## check if data is on the &quot;T&quot;-grid</span>
    <span class="n">on_Tgrid</span> <span class="o">=</span> <span class="s2">&quot;TLONG&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">coords</span>

    <span class="c1">## handle trimming for T-grid</span>
    <span class="k">if</span> <span class="n">on_Tgrid</span><span class="p">:</span>

        <span class="c1">## helper function to check if &#39;x&#39; is in &#39;x_range&#39;</span>
        <span class="n">isin_range</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_range</span><span class="p">:</span> <span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1">## get mask for data in given lon/lat range</span>
        <span class="n">in_lon_range</span> <span class="o">=</span> <span class="n">isin_range</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;TLONG&#39;</span><span class="p">],</span><span class="n">lon_range</span><span class="p">)</span>
        <span class="n">in_lat_range</span> <span class="o">=</span> <span class="n">isin_range</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TLAT&quot;</span><span class="p">],</span> <span class="n">lat_range</span><span class="p">)</span>
        
        <span class="n">in_lonlat_range</span> <span class="o">=</span> <span class="n">in_lon_range</span> <span class="o">&amp;</span> <span class="n">in_lat_range</span>

        <span class="c1">## load to memory</span>
        <span class="n">in_lonlat_range</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="c1">## Retain all points with at least one valid grid cell</span>
        <span class="n">x_idx</span> <span class="o">=</span> <span class="n">in_lonlat_range</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="s2">&quot;nlat&quot;</span><span class="p">)</span>
        <span class="n">y_idx</span> <span class="o">=</span> <span class="n">in_lonlat_range</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="s2">&quot;nlon&quot;</span><span class="p">)</span>

        <span class="c1">## select given points</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nlon</span><span class="o">=</span><span class="n">x_idx</span><span class="p">,</span> <span class="n">nlat</span><span class="o">=</span><span class="n">y_idx</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_range</span><span class="p">),</span> <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_range</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="load-trim-save-data">
<h1>Load, trim, save data<a class="headerlink" href="#load-trim-save-data" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Path to file server</span>
<span class="n">SERVER_FP</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/vortexfs1/share&quot;</span><span class="p">)</span>

<span class="c1">## Specify folder location for saving trimmed data (&quot;./&quot; means current directory)</span>
<span class="n">save_fp</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Load data</span>

<span class="c1">#this is janky because all these data products have different lat ranges; load one at a time and change trim</span>

<span class="c1">## specify arguments common to all datasets</span>
<span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">varname</span><span class="o">=</span><span class="s2">&quot;SST&quot;</span><span class="p">,</span> <span class="n">simulation_type</span><span class="o">=</span><span class="s2">&quot;hist&quot;</span><span class="p">,</span> <span class="n">save_fp</span><span class="o">=</span><span class="n">save_fp</span><span class="p">,</span> <span class="n">preprocess_func</span><span class="o">=</span><span class="n">preprocess</span><span class="p">)</span>

<span class="c1">## Load the data</span>
<span class="n">lens_SH_S</span> <span class="o">=</span> <span class="n">load_ensemble</span><span class="p">(</span><span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="o">-</span><span class="mi">45</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">lens_SH_N</span> <span class="o">=</span> <span class="n">load_ensemble</span><span class="p">(</span><span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">45</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">lens_NH_S</span> <span class="o">=</span> <span class="n">load_ensemble</span><span class="p">(</span><span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">45</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">lens_NH_N</span> <span class="o">=</span> <span class="n">load_ensemble</span><span class="p">(</span><span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="mi">45</span><span class="p">,</span><span class="mi">90</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">lens_EQ</span> <span class="o">=</span> <span class="n">load_ensemble</span><span class="p">(</span><span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">lens_EQ2</span> <span class="o">=</span> <span class="n">load_ensemble</span><span class="p">(</span><span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="c1">## Merge into single xr.Dataset</span>
<span class="n">lens</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">lens_SH_S</span><span class="p">[</span><span class="s2">&quot;SST&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;SH_S&quot;</span><span class="p">),</span>
        <span class="n">lens_SH_N</span><span class="p">[</span><span class="s2">&quot;SST&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;SH_N&quot;</span><span class="p">),</span>
        <span class="n">lens_NH_S</span><span class="p">[</span><span class="s2">&quot;SST&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;NH_S&quot;</span><span class="p">),</span>
        <span class="n">lens_NH_N</span><span class="p">[</span><span class="s2">&quot;SST&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;NH_N&quot;</span><span class="p">),</span>
        <span class="n">lens_EQ</span><span class="p">[</span><span class="s2">&quot;SST&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;EQ&quot;</span><span class="p">),</span>
        <span class="n">lens_EQ2</span><span class="p">[</span><span class="s2">&quot;SST&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;EQ2&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1">## load into memory</span>
<span class="n">lens</span><span class="o">.</span><span class="n">load</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">OSError</span><span class="g g-Whitespace">                                   </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span> <span class="mi">9</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">varname</span><span class="o">=</span><span class="s2">&quot;SST&quot;</span><span class="p">,</span> <span class="n">simulation_type</span><span class="o">=</span><span class="s2">&quot;hist&quot;</span><span class="p">,</span> <span class="n">save_fp</span><span class="o">=</span><span class="n">save_fp</span><span class="p">,</span> <span class="n">preprocess_func</span><span class="o">=</span><span class="n">preprocess</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="c1">## Load the data</span>
<span class="ne">----&gt; </span><span class="mi">9</span> <span class="n">lens_SH_S</span> <span class="o">=</span> <span class="n">load_ensemble</span><span class="p">(</span><span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="o">-</span><span class="mi">45</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">lens_SH_N</span> <span class="o">=</span> <span class="n">load_ensemble</span><span class="p">(</span><span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">45</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="n">lens_NH_S</span> <span class="o">=</span> <span class="n">load_ensemble</span><span class="p">(</span><span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">45</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">Cell In[2], line 442,</span> in <span class="ni">load_ensemble</span><span class="nt">(varname, simulation_type, lat_range, preprocess_func, save_fp)</span>
<span class="g g-Whitespace">    </span><span class="mi">437</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">save_fp</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">439</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">440</span> 
<span class="g g-Whitespace">    </span><span class="mi">441</span>     <span class="c1">## load the data and save to file for next time</span>
<span class="ne">--&gt; </span><span class="mi">442</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">load_ensemble_helper</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">444</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saving to file&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">445</span>     <span class="n">data</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_fp</span><span class="p">)</span>

<span class="nn">Cell In[2], line 397,</span> in <span class="ni">load_ensemble_helper</span><span class="nt">(varname, simulation_type, preprocess_func)</span>
<span class="g g-Whitespace">    </span><span class="mi">395</span> <span class="c1">## put results in list</span>
<span class="g g-Whitespace">    </span><span class="mi">396</span> <span class="n">member_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">36</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span><span class="mi">108</span><span class="p">)])</span>
<span class="ne">--&gt; </span><span class="mi">397</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_simulation</span><span class="p">(</span><span class="n">member_id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">member_ids</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">399</span> <span class="c1">## concatenate data along the &quot;ensemble&quot; dimension</span>
<span class="g g-Whitespace">    </span><span class="mi">400</span> <span class="n">ensemble_dim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">43</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;member&quot;</span><span class="p">)</span>

<span class="nn">Cell In[2], line 397,</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">395</span> <span class="c1">## put results in list</span>
<span class="g g-Whitespace">    </span><span class="mi">396</span> <span class="n">member_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">36</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span><span class="mi">108</span><span class="p">)])</span>
<span class="ne">--&gt; </span><span class="mi">397</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_simulation</span><span class="p">(</span><span class="n">member_id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">member_ids</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">399</span> <span class="c1">## concatenate data along the &quot;ensemble&quot; dimension</span>
<span class="g g-Whitespace">    </span><span class="mi">400</span> <span class="n">ensemble_dim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">43</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;member&quot;</span><span class="p">)</span>

<span class="nn">Cell In[2], line 368,</span> in <span class="ni">load_simulation</span><span class="nt">(varname, member_id, simulation_type, preprocess_func, use_jetstream)</span>
<span class="g g-Whitespace">    </span><span class="mi">365</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not a valid simulation type&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">367</span> <span class="c1">#### 3. open the relevant datasets, applying preprocessing function</span>
<span class="ne">--&gt; </span><span class="mi">368</span> <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">369</span>     <span class="n">paths</span><span class="o">=</span><span class="n">data_fp</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_pattern</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">370</span>     <span class="n">preprocess</span><span class="o">=</span><span class="n">preprocess_func</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">371</span>     <span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
<span class="g g-Whitespace">    </span><span class="mi">372</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">374</span> <span class="k">return</span> <span class="n">data</span><span class="p">[[</span><span class="n">varname</span><span class="p">,</span><span class="s2">&quot;TAREA&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nn">File ~/research/whoi-climate-tutorial_2025/envs/lib/python3.11/site-packages/xarray/backends/api.py:1597,</span> in <span class="ni">open_mfdataset</span><span class="nt">(paths, chunks, concat_dim, compat, preprocess, engine, data_vars, coords, combine, parallel, join, attrs_file, combine_attrs, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1594</span> <span class="n">paths</span> <span class="o">=</span> <span class="n">_find_absolute_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1596</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">paths</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1597</span>     <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;no files to open&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1599</span> <span class="n">paths1d</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">ReadBuffer</span><span class="p">]</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span> <span class="k">if</span> <span class="n">combine</span> <span class="o">==</span> <span class="s2">&quot;nested&quot;</span><span class="p">:</span>

<span class="ne">OSError</span>: no files to open
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="plot-data-sample">
<h1>plot data sample<a class="headerlink" href="#plot-data-sample" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_setup_global</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot Atlantic region&quot;&quot;&quot;</span>

    <span class="c1">## adjust figure size</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1">## specify map projection</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">## get ax object</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_setup</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span>
        <span class="n">proj</span><span class="p">,</span>
        <span class="n">lon_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">],</span>
        <span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span>
        <span class="n">xticks</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
        <span class="n">yticks</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1">## make background of trop. Pacific</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_setup_global</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="c1">## plot the data</span>

<span class="n">plot_data</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span> 
    <span class="n">lens_SH_S</span><span class="o">.</span><span class="n">TLONG</span><span class="p">,</span>
    <span class="n">lens_SH_S</span><span class="o">.</span><span class="n">TLAT</span><span class="p">,</span>
    <span class="n">lens_SH_S</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">member</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;cmo.thermal&quot;</span><span class="p">,</span>
    <span class="c1">#vmax=30,</span>
    <span class="c1">#vmin=15,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="timeseries">
<h1>timeseries<a class="headerlink" href="#timeseries" title="Link to this heading">#</a></h1>
<p>‘’’
In LENS, you could isolate the effect of external forcing by averaging over all ensemble members.
After ensemble-averaging, you could remove a linear trend (implicitly representing non-volcanic external
forcing) and the seasonal cycle; hopefully, the resulting anomalies are dominated by the volcanic forcing.
So the resulting anomalies would be your “residual” timeseries, called R(t) in the paper.
Once you have this R(t), you could try to reproduce some of the plots in the
paper (e.g., their Figs 3a and 3b).
‘’’</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## which index to look at</span>
<span class="n">region</span> <span class="o">=</span> <span class="s2">&quot;SH_N&quot;</span>

<span class="c1">## should we detrend?</span>
<span class="n">remove_trend</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">#ensemble averaging</span>
<span class="n">ensemble_mean</span> <span class="o">=</span> <span class="n">lens</span><span class="p">[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;member&quot;</span><span class="p">])</span>

<span class="c1">#remove seasonal cycle</span>
<span class="n">data_deseason</span> <span class="o">=</span> <span class="n">ensemble_mean</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">ensemble_mean</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># get polynomial trend</span>
<span class="n">trend</span> <span class="o">=</span> <span class="n">get_trend</span><span class="p">(</span><span class="n">data_deseason</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## specify which region to plot</span>
<span class="c1">## plot ensemble mean</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1">## plot data</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">lens</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
    <span class="n">data_deseason</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LENS Ensemble mean&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1">## plot trend</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">lens</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
    <span class="n">trend</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LENS Ensemble mean&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1">## label</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$^{\circ}C$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2006</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)])</span>

<span class="c1">## Add some markers</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1982</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1963</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1991</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span><span class="mf">.5</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/955fc62346a43785e5f25e3e78170464f8fd882315cc054fd6c9a5e631bbcdb4.png" src="../../_images/955fc62346a43785e5f25e3e78170464f8fd882315cc054fd6c9a5e631bbcdb4.png" />
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./pages/tutorial_11-7"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Imports</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-fns">Helper fns</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-trim-save-data">Load, trim, save data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-data-sample">plot data sample</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#timeseries">timeseries</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Theo Carr
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>