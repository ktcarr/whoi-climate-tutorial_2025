
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Example &#8212; WHOI Climate Data Tutorial (2025)</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'pages/model_validation/example';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3) Single-model climate-change" href="../single_model/overview.html" />
    <link rel="prev" title="2) Model validation" href="overview.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo2.svg" class="logo__image only-light" alt="WHOI Climate Data Tutorial (2025) - Home"/>
    <script>document.write(`<img src="../../_static/logo2.svg" class="logo__image only-dark" alt="WHOI Climate Data Tutorial (2025) - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../setup/setup.html">0) Setup</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1yKFb-_fa_Z-WPbMJax3rHNFw9lOVioPsFmkPtsnXynI/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup/setup_venv.html">Python / virtual environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup/connect_to_server.html">Accessing the CMIP data servers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup/test.html">Test the setup worked!</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../data_analysis/overview.html">1) Climate diagnostics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1bwNsn7P8J24s__1svavDL2vwk0QB2eK0PjDc0EKwnMU/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_analysis/setup-changes.html">Set-up changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_analysis/example.html">Example</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="overview.html">2) Model validation</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1pOMZBwi7BtkkiM8KvIcDS0DyyNMhudgcL7nRoUsCRso/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Example</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../single_model/overview.html">3) Single-model climate-change</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1W0gHDGQoarfeodf-VUkXuN2tNRnU3pRR_PxaNXpYGKM/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../single_model/example.html">Example</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../single_model_ensemble/overview.html">4) Single-model ensemble</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../single_model_ensemble/woods-hole_example.html">Example</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../intermodel_comp/overview.html">5) Intermodel comparison</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../intermodel_comp/example.html">Intermodel comparison example</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../examples/overview.html">6) Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://docs.google.com/presentation/d/1bAFB9mO22WYc6El3nojJgDyJqpis6xx5XXz0Tj2rMbI/edit?usp=sharing">Slides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/azores_prep.html">Azores high: data prep</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/azores_analysis.html">Azores high: analysis</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../resources/resources.html">Resources</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../resources/FAQ.html">FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources/xarray_reference.html">Xarray reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources/git_basics.html">Git basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources/ersst_cloud.html">Accessing ERSST on the cloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources/cesm_cloud.html">Accessing CESM2-LENS on the cloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources/setup_hpc.html">High-performance computing</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/ktcarr/whoi-climate-tutorial_2025/blob/main/docs/pages/model_validation/example.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ktcarr/whoi-climate-tutorial_2025" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ktcarr/whoi-climate-tutorial_2025/issues/new?title=Issue%20on%20page%20%2Fpages/model_validation/example.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/pages/model_validation/example.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Example</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">Data loading</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions">Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#for-loading-from-cloud">for loading from cloud</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#for-loading-from-server">for loading from server</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#utilities">utilities</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-handling">Data-handling</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#do-the-data-loading">Do the data-loading</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis">Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timeseries-of-t-wh">1. Timeseries of <span class="math notranslate nohighlight">\(T_{wh}\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#histogram-of-t-wh">2. Histogram of <span class="math notranslate nohighlight">\(T_{wh}\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-bias">3. Spatial bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#histogram-of-gridcell-level-bias">4. Histogram of gridcell-level bias</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="example">
<h1>Example<a class="headerlink" href="#example" title="Link to this heading">#</a></h1>
<p>In this example, we’ll compare ERA5 reanalysis outputs with a single climate model.<br />
<a class="reference download internal" download="" href="../../_downloads/57d038a8b219d51c6e9e6a8ce7010aa7/example.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">notebook</span></code></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cmocean</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xesmf</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xe</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">intake</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span>

<span class="c1">## (optional) remove gridlines from plots</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;axes.facecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;axes.grid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<section id="data-loading">
<h2>Data loading<a class="headerlink" href="#data-loading" title="Link to this heading">#</a></h2>
<section id="functions">
<h3>Functions<a class="headerlink" href="#functions" title="Link to this heading">#</a></h3>
<section id="for-loading-from-cloud">
<h4>for loading from cloud<a class="headerlink" href="#for-loading-from-cloud" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">prep_lsm</span><span class="p">(</span><span class="n">lsm</span><span class="p">,</span> <span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare land-sea mask by renaming coords,</span>
<span class="sd">    downsampling to 1x1 grid, and selecting specified lon/lat range&quot;&quot;&quot;</span>

    <span class="c1">## rename coords</span>
    <span class="n">lsm</span> <span class="o">=</span> <span class="n">lsm</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">})</span>

    <span class="c1">## get coords for interpolation (downscale to 1x1 grid)</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lon_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lat_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">new_coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span>

    <span class="c1">## interpolate to grid</span>
    <span class="n">lsm</span> <span class="o">=</span> <span class="n">lsm</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_coords</span><span class="p">)</span>

    <span class="c1">## add binary mask for regridding</span>
    <span class="n">lsm</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsm</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lsm</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_lsm_from_cloud</span><span class="p">(</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load ERA5 land-sea-mask from Google server&quot;&quot;&quot;</span>

    <span class="c1">## use ERA5 land-sea mask</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span>
        <span class="s2">&quot;gs://weatherbench2/datasets/era5/1959-2023_01_10-wb13-6h-1440x721_with_derived_variables.zarr&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">## load lsm into memory</span>
    <span class="n">lsm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;land_sea_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">prep_lsm</span><span class="p">(</span><span class="n">lsm</span><span class="p">,</span> <span class="n">lon_range</span><span class="o">=</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="o">=</span><span class="n">lat_range</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_era5_from_cloud</span><span class="p">(</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">,</span> <span class="n">apply_ocean_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load ERA5 from Google server with consistent processing&quot;&quot;&quot;</span>

    <span class="c1">## open data and get 2m temperature</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span>
        <span class="s2">&quot;gs://weatherbench2/datasets/era5/1959-2023_01_10-6h-240x121_equiangular_with_poles_conservative.zarr&quot;</span><span class="p">,</span>
        <span class="n">chunks</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">1024</span><span class="p">),</span>
    <span class="p">)[</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">]</span>

    <span class="c1">## subset for lon/lat range</span>
    <span class="n">lonlat_idx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_range</span><span class="p">),</span> <span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_range</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">lonlat_idx</span><span class="p">)</span>

    <span class="c1">## load into memory</span>
    <span class="n">data</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

    <span class="c1">## convert kelvin to celsius</span>
    <span class="n">data_celsius</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">-</span> <span class="mf">273.15</span>

    <span class="c1">## resample from 6-hourly to monthly</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_celsius</span><span class="o">.</span><span class="n">resample</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;MS&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1">## transpose data (consistent with data on server)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">)</span>

    <span class="c1">## Apply ocean mask if requested</span>
    <span class="k">if</span> <span class="n">apply_ocean_mask</span><span class="p">:</span>
        <span class="n">lsm</span> <span class="o">=</span> <span class="n">load_lsm_from_cloud</span><span class="p">(</span><span class="n">lon_range</span><span class="o">=</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="o">=</span><span class="n">lat_range</span><span class="p">)</span>
        <span class="n">ocean_mask</span> <span class="o">=</span> <span class="n">lsm</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>
        <span class="n">ocean_mask</span> <span class="o">=</span> <span class="n">ocean_mask</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;longitude&quot;</span><span class="p">})</span>

        <span class="c1"># Interpolate ocean mask to ERA5 grid</span>
        <span class="n">ocean_mask_interp</span> <span class="o">=</span> <span class="n">ocean_mask</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">latitude</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">longitude</span>
        <span class="p">)</span>

        <span class="c1"># Apply mask (keep only ocean points)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ocean_mask_interp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_cesm_from_cloud</span><span class="p">(</span>
    <span class="n">lon_range</span><span class="p">,</span>
    <span class="n">lat_range</span><span class="p">,</span>
    <span class="n">varname</span><span class="o">=</span><span class="s2">&quot;TREFHT&quot;</span><span class="p">,</span>
    <span class="n">load_ssp370</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">member_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">apply_ocean_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load CESM data from cloud with consistent processing&quot;&quot;&quot;</span>

    <span class="c1">## get catalog of available data</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">open_esm_datastore</span><span class="p">(</span>
        <span class="s2">&quot;https://raw.githubusercontent.com/NCAR/cesm2-le-aws/main/intake-catalogs/aws-cesm2-le.json&quot;</span>
    <span class="p">)</span>

    <span class="c1">## subset for temperature data</span>
    <span class="n">catalog_subset</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="s2">&quot;monthly&quot;</span><span class="p">)</span>

    <span class="c1">## kwargs for opening data</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">aggregate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">xarray_open_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;zarr&quot;</span><span class="p">,</span> <span class="n">decode_timedelta</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">zarr_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;consolidated&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="n">storage_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;anon&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="c1">## open data (but don&#39;t load to memory)</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="n">catalog_subset</span><span class="o">.</span><span class="n">to_dataset_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">dsets</span><span class="p">[</span><span class="s2">&quot;atm.historical.monthly.cmip6&quot;</span><span class="p">]</span>

    <span class="c1">## optionally load ssp data as well</span>
    <span class="k">if</span> <span class="n">load_ssp370</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">dsets</span><span class="p">[</span><span class="s2">&quot;atm.ssp370.monthly.cmip6&quot;</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="c1">## trim data (select ensemble members and lon/lat space)</span>
    <span class="n">lonlat_idx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_range</span><span class="p">),</span> <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_range</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lonlat_idx</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">member_id</span><span class="o">=</span><span class="n">member_id</span><span class="p">)</span>

    <span class="c1">## convert kelvin to celsius</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>

    <span class="c1">## swap longitude range</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">swap_longitude_range</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1">## load to memory</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="c1">## Regrid to regular grid and optionally apply ocean mask</span>
    <span class="n">lsm</span> <span class="o">=</span> <span class="n">load_lsm_from_cloud</span><span class="p">(</span><span class="n">lon_range</span><span class="o">=</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="o">=</span><span class="n">lat_range</span><span class="p">)</span>
    <span class="n">regridder</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">Regridder</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lsm</span><span class="p">,</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="n">ignore_degenerate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">regridder</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1">## Apply ocean mask if requested</span>
    <span class="k">if</span> <span class="n">apply_ocean_mask</span><span class="p">:</span>
        <span class="n">ocean_mask</span> <span class="o">=</span> <span class="n">lsm</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ocean_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="for-loading-from-server">
<h4>for loading from server<a class="headerlink" href="#for-loading-from-server" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_simulation</span><span class="p">(</span>
    <span class="n">server_fp</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">member_id</span><span class="p">,</span> <span class="n">simulation_type</span><span class="p">,</span> <span class="n">preprocess_func</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load dataset for single simulation, for single variable.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        - varname: name of variable to load, one of {&quot;SST&quot;,&quot;PSL&quot;}</span>
<span class="sd">        - member_id: ID of ensemble member to load, an integer in the range [1,10]</span>
<span class="sd">        - simulation_type: one of {&quot;hist&quot;, &quot;rcp85&quot;}</span>
<span class="sd">    Returns:</span>
<span class="sd">        - xarray dataarray with given data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Filepath to the CESM LENS dataset</span>
    <span class="n">lens_fp</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;cmip6/data/cmip6/CMIP/NCAR/LENS&quot;</span><span class="p">)</span>

    <span class="c1">#### 1. get filepath to data</span>
    <span class="n">data_fp</span> <span class="o">=</span> <span class="n">server_fp</span> <span class="o">/</span> <span class="n">lens_fp</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>

    <span class="c1">#### 2. get naming pattern for files to open</span>
    <span class="k">if</span> <span class="n">simulation_type</span> <span class="o">==</span> <span class="s2">&quot;hist&quot;</span><span class="p">:</span>
        <span class="n">file_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;*20TRC*.</span><span class="si">{</span><span class="n">member_id</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">.*.nc&quot;</span>

    <span class="k">elif</span> <span class="n">simulation_type</span> <span class="o">==</span> <span class="s2">&quot;rcp85&quot;</span><span class="p">:</span>
        <span class="n">file_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;*RCP85*.</span><span class="si">{</span><span class="n">member_id</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">.*.nc&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not a valid simulation type&quot;</span><span class="p">)</span>

    <span class="c1">#### 3. open the relevant datasets, applying preprocessing function</span>

    <span class="c1">## filepath to data</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_fp</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_pattern</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">## load data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decode_timedelta</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">## apply (optional) preprocessing</span>
    <span class="k">if</span> <span class="n">preprocess_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">preprocess_func</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_lsm_from_server</span><span class="p">(</span><span class="n">server_fp</span><span class="p">,</span> <span class="n">lon_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">],</span> <span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load ERA5 land-sea-mask from CMIP6 server&quot;&quot;&quot;</span>

    <span class="c1">## get server path to ERA5 land sea mask</span>
    <span class="n">lsm_fp</span> <span class="o">=</span> <span class="n">server_fp</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span>
        <span class="s2">&quot;cmip6/data/era5/reanalysis/single-levels/monthly-means/land_sea_mask/2020_land_sea_mask.nc&quot;</span>
    <span class="p">)</span>

    <span class="c1">## open lsm</span>
    <span class="n">lsm</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">lsm_fp</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prep_lsm</span><span class="p">(</span><span class="n">lsm</span><span class="p">,</span> <span class="n">lon_range</span><span class="o">=</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="o">=</span><span class="n">lat_range</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_cesm_from_server</span><span class="p">(</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">,</span> <span class="n">server_fp</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">member_id</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load CESM SST data with minimal preprocessing - SST datasets are typically already ocean-masked&quot;&quot;&quot;</span>
    <span class="c1">## shared arguments for loading data</span>
    <span class="n">load_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">server_fp</span><span class="o">=</span><span class="n">server_fp</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span> <span class="n">member_id</span><span class="o">=</span><span class="n">member_id</span><span class="p">)</span>

    <span class="c1">## Load data</span>
    <span class="n">data_hist</span> <span class="o">=</span> <span class="n">load_simulation</span><span class="p">(</span><span class="n">simulation_type</span><span class="o">=</span><span class="s2">&quot;hist&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">load_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">data_rcp</span> <span class="o">=</span> <span class="n">load_simulation</span><span class="p">(</span><span class="n">simulation_type</span><span class="o">=</span><span class="s2">&quot;rcp85&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">load_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="c1">## concatenate in time</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_hist</span><span class="p">,</span> <span class="n">data_rcp</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="c1">## rename coordinates for convenience</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;TLONG&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;TLAT&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">})</span>

    <span class="c1">## subset data by longitude and latitude</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">trim</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lon_range</span><span class="o">=</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="o">=</span><span class="n">lat_range</span><span class="p">)</span>

    <span class="c1">## swap longitude range from [0,360) to (-180, 180] if needed</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">swap_longitude_range</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1">## make sure longitude is in ascending order</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sort_longitude</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Only apply basic masking to remove obvious invalid values (like 0 or very negative values)</span>
    <span class="c1"># SST datasets should already be ocean-masked</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># Remove obviously invalid SST values</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_era5_from_server</span><span class="p">(</span><span class="n">server_fp</span><span class="p">,</span> <span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load ERA5 data from CMIP6 server&quot;&quot;&quot;</span>

    <span class="c1">## Filepath to the ERA5 reanalysis</span>
    <span class="n">era5_fp</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;cmip6/data/era5/reanalysis/single-levels/monthly-means&quot;</span><span class="p">)</span>

    <span class="c1">## sea surface temperature (SST) filepaths</span>
    <span class="n">era5_fp_sst</span> <span class="o">=</span> <span class="n">server_fp</span> <span class="o">/</span> <span class="n">era5_fp</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">)</span>

    <span class="c1">## open the data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">era5_fp_sst</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.nc&quot;</span><span class="p">))[</span><span class="s2">&quot;sst&quot;</span><span class="p">]</span>

    <span class="c1">## convert kelvin to celsius</span>
    <span class="n">data_celsius</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">-</span> <span class="mf">273.15</span>

    <span class="c1">## select lon/lat range</span>
    <span class="n">lonlat_idx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_range</span><span class="p">),</span> <span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_range</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_celsius</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lonlat_idx</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="c1">## put latitudes in ascending order</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reindex</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]})</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="utilities">
<h4>utilities<a class="headerlink" href="#utilities" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">trim</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;select part of data in given longitude/latitude range&quot;&quot;&quot;</span>

    <span class="c1">## helper function to check if &#39;x&#39; is in &#39;x_range&#39;</span>
    <span class="n">isin_range</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_range</span><span class="p">:</span> <span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1">## get mask for data in given lon/lat range</span>
    <span class="n">in_lon_range</span> <span class="o">=</span> <span class="n">isin_range</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">lon_range</span><span class="p">)</span>
    <span class="n">in_lat_range</span> <span class="o">=</span> <span class="n">isin_range</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">lat_range</span><span class="p">)</span>
    <span class="n">in_lonlat_range</span> <span class="o">=</span> <span class="n">in_lon_range</span> <span class="o">&amp;</span> <span class="n">in_lat_range</span>

    <span class="c1">## load to memory</span>
    <span class="n">in_lonlat_range</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;nlon&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>

        <span class="c1">## Retain all points with at least one valid grid cell</span>
        <span class="n">x_idx</span> <span class="o">=</span> <span class="n">in_lonlat_range</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="s2">&quot;nlat&quot;</span><span class="p">)</span>
        <span class="n">y_idx</span> <span class="o">=</span> <span class="n">in_lonlat_range</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="s2">&quot;nlon&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nlon</span><span class="o">=</span><span class="n">x_idx</span><span class="p">,</span> <span class="n">nlat</span><span class="o">=</span><span class="n">y_idx</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">in_lon_range</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">in_lat_range</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sort_longitude</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;shuffles data so that longitude is monotonically increasing&quot;&quot;&quot;</span>

    <span class="c1">## Transpose data so that longitude is last dimension</span>
    <span class="c1">## (we&#39;ll do all the sorting along this dimension)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="s2">&quot;nlon&quot;</span><span class="p">)</span>

    <span class="c1">## Get indices needed to sort longitude to be monotonic increasing</span>
    <span class="n">lon_sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">## sort the lon/lat coordindates</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">idx</span><span class="o">=</span><span class="n">lon_sort_idx</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">idx</span><span class="o">=</span><span class="n">lon_sort_idx</span><span class="p">)</span>

    <span class="c1">#### sort the data</span>

    <span class="c1"># first, check to see if data has more than two dimensions</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">extra_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">lon_sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">lon_sort_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">extra_dims</span><span class="p">)</span>

    <span class="c1">## now, do the actual sorting</span>
    <span class="n">data</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">lon_sort_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">swap_longitude_range</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;swap longitude range of xr.DataArray from [0,360) to (-180, 180].&quot;&quot;&quot;</span>

    <span class="c1">## make copy of longitude coordinate to be modified</span>
    <span class="n">lon_new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1">## relabel values greater than 180</span>
    <span class="n">exceeds_180</span> <span class="o">=</span> <span class="n">lon_new</span> <span class="o">&gt;</span> <span class="mi">180</span>
    <span class="n">lon_new</span><span class="p">[</span><span class="n">exceeds_180</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">360</span> <span class="o">+</span> <span class="n">lon_new</span><span class="p">[</span><span class="n">exceeds_180</span><span class="p">]</span>

    <span class="c1">## Update the coordinate on the xarray object</span>
    <span class="k">if</span> <span class="s2">&quot;lon&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">lon_new</span><span class="p">})</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">lon_new</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="data-handling">
<h4>Data-handling<a class="headerlink" href="#data-handling" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ensure_consistent_grids</span><span class="p">(</span><span class="n">era5_data</span><span class="p">,</span> <span class="n">cesm_data</span><span class="p">,</span> <span class="n">target_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure both datasets are on the same spatial grid&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">target_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use ERA5 grid as target by default</span>
        <span class="n">target_grid</span> <span class="o">=</span> <span class="n">era5_data</span>

    <span class="c1"># Check if CESM needs regridding to match ERA5</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">cesm_data</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">target_grid</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">cesm_data</span><span class="o">.</span><span class="n">long</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">target_grid</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regridding CESM data to match ERA5 grid...&quot;</span><span class="p">)</span>
        <span class="n">regridder</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">Regridder</span><span class="p">(</span>
            <span class="n">cesm_data</span><span class="p">,</span> <span class="n">target_grid</span><span class="p">,</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="n">ignore_degenerate</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">cesm_regridded</span> <span class="o">=</span> <span class="n">regridder</span><span class="p">(</span><span class="n">cesm_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">era5_data</span><span class="p">,</span> <span class="n">cesm_regridded</span>

    <span class="k">return</span> <span class="n">era5_data</span><span class="p">,</span> <span class="n">cesm_data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_comparable_datasets</span><span class="p">(</span>
    <span class="n">server_fp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lon_range</span><span class="o">=</span><span class="p">[</span><span class="mi">260</span><span class="p">,</span> <span class="mi">360</span><span class="p">],</span>
    <span class="n">lat_range</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span>
    <span class="n">member_id</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">load_from_cloud</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">load_ssp370</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load ERA5 and CESM datasets with consistent processing for comparison</span>

<span class="sd">    Args:</span>
<span class="sd">        server_fp: Path to server data (only needed if load_from_cloud=False)</span>
<span class="sd">        lon_range: Longitude range [min, max]</span>
<span class="sd">        lat_range: Latitude range [min, max]</span>
<span class="sd">        member_id: CESM ensemble member ID</span>
<span class="sd">        load_from_cloud: Whether to load from cloud (True) or server (False)</span>
<span class="sd">        load_ssp370: Whether to include SSP370 scenario for CESM</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (era5_data, cesm_data) - aligned and comparable datasets</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lon_range</span><span class="o">=</span><span class="n">lon_range</span><span class="p">,</span> <span class="n">lat_range</span><span class="o">=</span><span class="n">lat_range</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">load_from_cloud</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading from cloud...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- ERA5: 2m temperature with ocean mask&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- CESM: 2m temperature with ocean mask&quot;</span><span class="p">)</span>

        <span class="c1"># Load atmospheric 2m temp with ocean mask for both</span>
        <span class="n">era5_data</span> <span class="o">=</span> <span class="n">load_era5_from_cloud</span><span class="p">(</span><span class="n">apply_ocean_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">cesm_data</span> <span class="o">=</span> <span class="n">load_cesm_from_cloud</span><span class="p">(</span>
            <span class="n">varname</span><span class="o">=</span><span class="s2">&quot;TREFHT&quot;</span><span class="p">,</span>
            <span class="n">load_ssp370</span><span class="o">=</span><span class="n">load_ssp370</span><span class="p">,</span>
            <span class="n">member_id</span><span class="o">=</span><span class="n">member_id</span><span class="p">,</span>
            <span class="n">apply_ocean_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading from server...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- ERA5: SST (ocean only)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- CESM: SST (ocean only)&quot;</span><span class="p">)</span>

        <span class="c1"># Load ocean-only SST data</span>
        <span class="n">era5_data</span> <span class="o">=</span> <span class="n">load_era5_from_server</span><span class="p">(</span><span class="n">server_fp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">cesm_data</span> <span class="o">=</span> <span class="n">load_cesm_from_server</span><span class="p">(</span>
            <span class="n">varname</span><span class="o">=</span><span class="s2">&quot;SST&quot;</span><span class="p">,</span> <span class="n">server_fp</span><span class="o">=</span><span class="n">server_fp</span><span class="p">,</span> <span class="n">member_id</span><span class="o">=</span><span class="n">member_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="c1"># Align temporal bounds</span>
    <span class="c1"># era5_data, cesm_data = align_temporal_bounds(era5_data, cesm_data)</span>

    <span class="c1"># Ensure consistent spatial grids</span>
    <span class="n">era5_data</span><span class="p">,</span> <span class="n">cesm_data</span> <span class="o">=</span> <span class="n">ensure_consistent_grids</span><span class="p">(</span><span class="n">era5_data</span><span class="p">,</span> <span class="n">cesm_data</span><span class="p">)</span>

    <span class="c1"># Print summary statistics</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Dataset summary:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERA5 shape: </span><span class="si">{</span><span class="n">era5_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CESM shape: </span><span class="si">{</span><span class="n">cesm_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">era5_data</span><span class="p">,</span> <span class="n">cesm_data</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="do-the-data-loading">
<h3>Do the data-loading<a class="headerlink" href="#do-the-data-loading" title="Link to this heading">#</a></h3>
<div class="admonition-to-dos admonition">
<p class="admonition-title">To-dos</p>
<ol class="arabic simple">
<li><p><strong>Filepath</strong>: update the filepath <code class="docutils literal notranslate"><span class="pre">server_fp</span></code> in the code cell below. This is the location of the WHOI CMIP server on your computer (see <a class="reference internal" href="../setup/connect_to_server.html"><span class="std std-doc">server connection setup</span></a> for details). Note that <strong>the data loading functions assume the path to the data is</strong>: <code class="docutils literal notranslate"><span class="pre">SERVER_FP/cmip6/data/...</span></code>, but on some PCs the “cmip6” is omitted (<code class="docutils literal notranslate"><span class="pre">SERVER_FP/data/...</span></code>). If this is the case for you, you’ll need to modify the filepaths in the dataloading functions above (I recommend doing a “command f” search for “server_fp”). Sorry about that!</p></li>
<li><p><strong>Longitude/latitude range</strong> (optional): to look at a different region, update the <code class="docutils literal notranslate"><span class="pre">lon_range</span></code> and <code class="docutils literal notranslate"><span class="pre">lat_range</span></code> parameters in the code cell below (both are set inside of the <code class="docutils literal notranslate"><span class="pre">KWARGS</span></code> dictionary)</p></li>
</ol>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>CMIP server errors
The CMIP server seems unable to handle multiple users access the same file at once (e.g., during the actual tutorial session). If you get a mysterious error when trying to load data from the server (e.g., <code class="docutils literal notranslate"><span class="pre">NetCDF:</span> <span class="pre">HDF</span> <span class="pre">error</span></code>), try loading the data from the cloud instead (i.e., set <code class="docutils literal notranslate"><span class="pre">LOAD_FROM_CLOUD</span> <span class="pre">=</span> <span class="pre">True</span></code> in the code cell below).</p>
<p>In order to load ERA5 data from Google Cloud and CESM2 data from AWS, you need to install several additional packages (see <a class="reference internal" href="../data_analysis/setup-changes.html"><span class="std std-doc">this page</span></a> for details). In short, you can install these packages with:<br />
<code class="docutils literal notranslate"><span class="pre">mamba</span> <span class="pre">install</span> <span class="pre">-n</span> <span class="pre">my_new_env</span> <span class="pre">-c</span> <span class="pre">conda-forge</span> <span class="pre">gcsfs</span> <span class="pre">zarr</span> <span class="pre">s3fs</span> <span class="pre">intake-esm</span></code><br />
(assuming your environment is called <code class="docutils literal notranslate"><span class="pre">my_new_env</span></code>)</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Execute data loading</span>
<span class="n">SERVER_FP</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/Volumes&quot;</span><span class="p">)</span>
<span class="n">LON_RANGE</span> <span class="o">=</span> <span class="p">[</span><span class="mi">260</span><span class="p">,</span> <span class="mf">359.9</span><span class="p">]</span>
<span class="n">LAT_RANGE</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>
<span class="n">LOAD_FROM_CLOUD</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">## try to suppress file locking</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;HDF5_USE_FILE_LOCKING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FALSE&quot;</span>

<span class="c1">## Load comparable datasets</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">era5_data</span><span class="p">,</span> <span class="n">cesm_data</span> <span class="o">=</span> <span class="n">load_comparable_datasets</span><span class="p">(</span>
    <span class="n">server_fp</span><span class="o">=</span><span class="n">SERVER_FP</span><span class="p">,</span>
    <span class="n">lon_range</span><span class="o">=</span><span class="n">LON_RANGE</span><span class="p">,</span>
    <span class="n">lat_range</span><span class="o">=</span><span class="n">LAT_RANGE</span><span class="p">,</span>
    <span class="n">member_id</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">load_from_cloud</span><span class="o">=</span><span class="n">LOAD_FROM_CLOUD</span><span class="p">,</span>
    <span class="n">load_ssp370</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total loading time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading from server...
- ERA5: SST (ocean only)
- CESM: SST (ocean only)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Regridding CESM data to match ERA5 grid...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset summary:
ERA5 shape: (525, 281, 400)
CESM shape: (1932, 281, 400)

Total loading time: 97.7 seconds
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Link to this heading">#</a></h2>
<p>Lets do a similar timeseries analysis as we did in tutorial 1 but now compare the two datasets:</p>
<section id="id1">
<h3>Functions<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<div class="admonition-to-do-define-your-own-index admonition">
<p class="admonition-title">To-do: define your own index</p>
<p>E.g., choose a different region by modifying the function <code class="docutils literal notranslate"><span class="pre">compute_T_wh</span></code> below.</p>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">spatial_avg</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;function to compute spatial average of data on grid with constant</span>
<span class="sd">    longitude/latitude spacing.&quot;&quot;&quot;</span>

    <span class="c1">## determine coordinate names based on what&#39;s available</span>
    <span class="k">if</span> <span class="s2">&quot;latitude&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">lat_name</span> <span class="o">=</span> <span class="s2">&quot;latitude&quot;</span>
        <span class="n">lon_name</span> <span class="o">=</span> <span class="s2">&quot;longitude&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;lat&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">lat_name</span> <span class="o">=</span> <span class="s2">&quot;lat&quot;</span>
        <span class="n">lon_name</span> <span class="o">=</span> <span class="s2">&quot;lon&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Data must have either &#39;latitude&#39;/&#39;longitude&#39; or &#39;lat&#39;/&#39;lon&#39; coordinates&quot;</span>
        <span class="p">)</span>

    <span class="c1">## first, compute cosine of latitude (after converting degrees to radians)</span>
    <span class="n">latitude_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">lat_name</span><span class="p">])</span>
    <span class="n">cos_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">latitude_radians</span><span class="p">)</span>

    <span class="c1">## get weighted average using xarray</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">cos_lat</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">lon_name</span><span class="p">,</span> <span class="n">lat_name</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">avg</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_T_wh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ERA</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute Woods Hole temperature index&quot;&quot;&quot;</span>
    <span class="c1"># ERA = True for era5, False for cesm</span>
    <span class="n">ERA</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ERA</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ERA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">lonlat_idx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">287.5</span><span class="p">,</span> <span class="mf">293.5</span><span class="p">),</span> <span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">39</span><span class="p">,</span> <span class="mi">44</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">ERA</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">lonlat_idx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">287.5</span><span class="p">,</span> <span class="mf">293.5</span><span class="p">),</span> <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">39</span><span class="p">,</span> <span class="mi">44</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ERA must be True or False&quot;</span><span class="p">)</span>

    <span class="c1">## get subset of data inside the box</span>
    <span class="n">data_subset</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lonlat_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spatial_avg</span><span class="p">(</span><span class="n">data_subset</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_T_wh</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute Woods Hole temperature index&quot;&quot;&quot;</span>

    <span class="n">lonlat_idx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">287.5</span><span class="p">,</span> <span class="mf">293.5</span><span class="p">),</span> <span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">39</span><span class="p">,</span> <span class="mi">44</span><span class="p">))</span>

    <span class="c1">## get subset of data inside the box</span>
    <span class="n">data_subset</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lonlat_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spatial_avg</span><span class="p">(</span><span class="n">data_subset</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_empirical_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the &quot;empirical&quot; probability distribution function for the data x.</span>
<span class="sd">    In this case the result is a normalized histogram,</span>
<span class="sd">    Normalized means that integrating over the histogram yields 1.</span>
<span class="sd">    Returns the PDF (normalized histogram) and edges of the histogram bins</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## compute histogram</span>
    <span class="k">if</span> <span class="n">bin_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>

    <span class="c1">## normalize to a probability distribution (PDF)</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">hist</span> <span class="o">/</span> <span class="p">(</span><span class="n">hist</span> <span class="o">*</span> <span class="n">bin_width</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">bin_edges</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_gaussian_best_fit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get gaussian best fit to data, and evaluate</span>
<span class="sd">    probabilities over the range of the data.&quot;&quot;&quot;</span>

    <span class="c1">## get normal distribution best fit</span>
    <span class="n">gaussian</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">scale</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

    <span class="c1">## evaluate over range of data</span>
    <span class="c1"># Fix: x is already a numpy array, so use x directly instead of x.values</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">x_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">amp</span><span class="p">,</span> <span class="n">amp</span><span class="p">)</span>
    <span class="n">pdf_eval</span> <span class="o">=</span> <span class="n">gaussian</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_eval</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pdf_eval</span><span class="p">,</span> <span class="n">x_eval</span>


<span class="c1"># Compute JAS (July-August-September) seasonal averages</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_jas_averages</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract JAS seasonal averages from monthly data&quot;&quot;&quot;</span>
    <span class="c1"># Get month numbers</span>
    <span class="n">months</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>

    <span class="c1"># Create mask for JAS months (7, 8, 9)</span>
    <span class="n">jas_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">months</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">months</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">)</span>

    <span class="c1"># Select JAS months</span>
    <span class="n">jas_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">jas_mask</span><span class="p">)</span>

    <span class="c1"># Group by year and compute mean for each JAS season</span>
    <span class="n">jas_yearly</span> <span class="o">=</span> <span class="n">jas_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jas_yearly</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_cb_range</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make colorbar_range for cmo.balance</span>
<span class="sd">    Args:</span>
<span class="sd">        - &#39;amp&#39;: amplitude of maximum value for colorbar</span>
<span class="sd">        - &#39;delta&#39;: increment for colorbar</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">amp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">amp</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span> <span class="n">delta</span><span class="p">)]</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_trend</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get trend for an xr.dataarray along specified dimension,</span>
<span class="sd">    by fitting polynomial of degree &#39;deg&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Get coefficients for best fit</span>
    <span class="n">polyfit_coefs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)[</span><span class="s2">&quot;polyfit_coefficients&quot;</span><span class="p">]</span>

    <span class="c1">## Get best fit line (linear trend in this case)</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">polyfit_coefs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trend</span>


<span class="k">def</span><span class="w"> </span><span class="nf">detrend</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove trend of degree &#39;deg&#39; from data, along dimension &#39;dim&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">data</span> <span class="o">-</span> <span class="n">get_trend</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">detrend_by_month</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove trend of degree &quot;deg&quot; from data along &quot;dim&quot;, for each month separately</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">detrend</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="timeseries-of-t-wh">
<h3>1. Timeseries of <span class="math notranslate nohighlight">\(T_{wh}\)</span><a class="headerlink" href="#timeseries-of-t-wh" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute T_wh for both datasets</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing Woods Hole temperature index...&quot;</span><span class="p">)</span>
<span class="n">t_wh_era5</span> <span class="o">=</span> <span class="n">compute_T_wh</span><span class="p">(</span><span class="n">era5_data</span><span class="p">)</span>
<span class="n">t_wh_cesm</span> <span class="o">=</span> <span class="n">compute_T_wh</span><span class="p">(</span><span class="n">cesm_data</span><span class="p">)</span>

<span class="c1"># Select time period 1979-2006 first</span>
<span class="n">t_wh_era5_1979_2006</span> <span class="o">=</span> <span class="n">t_wh_era5</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s2">&quot;1979-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2006-12-31&quot;</span><span class="p">))</span>
<span class="n">t_wh_cesm_1979_2006</span> <span class="o">=</span> <span class="n">t_wh_cesm</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s2">&quot;1979-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2006-12-31&quot;</span><span class="p">))</span>

<span class="c1"># Compute JAS averages for both datasets</span>
<span class="n">era5_jas</span> <span class="o">=</span> <span class="n">get_jas_averages</span><span class="p">(</span><span class="n">t_wh_era5_1979_2006</span><span class="p">)</span>
<span class="n">cesm_jas</span> <span class="o">=</span> <span class="n">get_jas_averages</span><span class="p">(</span><span class="n">t_wh_cesm_1979_2006</span><span class="p">)</span>

<span class="c1"># Create timeseries plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">era5_jas</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
    <span class="n">era5_jas</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;b-o&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ERA5&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">cesm_jas</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
    <span class="n">cesm_jas</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s2">&quot;r-s&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CESM&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;JAS Temperature (°C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Woods Hole Temperature Index (JAS season; 1979-2006)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># ## save to file</span>
<span class="c1"># plt.savefig(&quot;figs/timeseries.svg&quot;)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Print some statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERA5 JAS statistics (1979-2006):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">era5_jas</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°C&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Std:  </span><span class="si">{</span><span class="n">era5_jas</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°C&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Min:  </span><span class="si">{</span><span class="n">era5_jas</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°C&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max:  </span><span class="si">{</span><span class="n">era5_jas</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°C&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CESM JAS statistics (1979-2006):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">cesm_jas</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°C&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Std:  </span><span class="si">{</span><span class="n">cesm_jas</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°C&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Min:  </span><span class="si">{</span><span class="n">cesm_jas</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°C&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max:  </span><span class="si">{</span><span class="n">cesm_jas</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°C&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing Woods Hole temperature index...
</pre></div>
</div>
<img alt="../../_images/4fbea19918bec06181f79e566fc530455eb546cdb2466e6e196b8a4142198921.png" src="../../_images/4fbea19918bec06181f79e566fc530455eb546cdb2466e6e196b8a4142198921.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ERA5 JAS statistics (1979-2006):
  Mean: 19.17°C
  Std:  0.66°C
  Min:  17.34°C
  Max:  20.51°C

CESM JAS statistics (1979-2006):
  Mean: 23.94°C
  Std:  0.39°C
  Min:  23.00°C
  Max:  24.71°C
</pre></div>
</div>
</div>
</div>
</section>
<section id="histogram-of-t-wh">
<h3>2. Histogram of <span class="math notranslate nohighlight">\(T_{wh}\)</span><a class="headerlink" href="#histogram-of-t-wh" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Preprocess: remove linear trend</span>
<span class="n">cesm_detrend</span> <span class="o">=</span> <span class="n">detrend_by_month</span><span class="p">(</span><span class="n">t_wh_cesm_1979_2006</span><span class="p">)</span>
<span class="n">era5_detrend</span> <span class="o">=</span> <span class="n">detrend_by_month</span><span class="p">(</span><span class="n">t_wh_era5_1979_2006</span><span class="p">)</span>

<span class="c1">## Compute histograms</span>
<span class="k">if</span> <span class="n">LOAD_FROM_CLOUD</span><span class="p">:</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">2.4</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.15</span>

<span class="n">pdf_era5</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_empirical_pdf</span><span class="p">(</span><span class="n">era5_detrend</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="n">edges</span><span class="p">)</span>
<span class="n">pdf_cesm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_empirical_pdf</span><span class="p">(</span><span class="n">cesm_detrend</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="n">edges</span><span class="p">)</span>

<span class="c1">#### Plot result</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">)</span>

<span class="c1">## plot histogram</span>
<span class="n">ax</span><span class="o">.</span><span class="n">stairs</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">pdf_era5</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="n">edges</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ERA5&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">stairs</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">pdf_cesm</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="n">edges</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CESM&quot;</span><span class="p">)</span>


<span class="c1">## plot zero line</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1">## label</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$K$ anomaly&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Prob. density&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>

<span class="c1"># ## save to file</span>
<span class="c1"># fig.savefig(&quot;figs/histogram.svg&quot;)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/587a4656c5794a5548fb8d5476f5cfa4ef800d10785c3d43bb9ba9a8c41ed4b5.png" src="../../_images/587a4656c5794a5548fb8d5476f5cfa4ef800d10785c3d43bb9ba9a8c41ed4b5.png" />
</div>
</div>
</section>
<section id="spatial-bias">
<h3>3. Spatial bias<a class="headerlink" href="#spatial-bias" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Align datasets to common time period (1979-2006)</span>
<span class="n">era5_common</span> <span class="o">=</span> <span class="n">era5_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s2">&quot;1979-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2006-12-31&quot;</span><span class="p">))</span>
<span class="n">cesm_common</span> <span class="o">=</span> <span class="n">cesm_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s2">&quot;1979-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2006-12-31&quot;</span><span class="p">))</span>

<span class="c1"># Compute JAS averages for both datasets</span>
<span class="n">era5_jas_mean</span> <span class="o">=</span> <span class="n">get_jas_averages</span><span class="p">(</span><span class="n">era5_common</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
<span class="n">cesm_jas_mean</span> <span class="o">=</span> <span class="n">get_jas_averages</span><span class="p">(</span><span class="n">cesm_common</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>

<span class="c1"># Compute error (ERA5 - CESM)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">cesm_jas_mean</span> <span class="o">-</span> <span class="n">era5_jas_mean</span>

<span class="c1"># Create spatial error plot with shared colorbar</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Create GridSpec for better control of subplot layout</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># ERA5 mean</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
    <span class="n">era5_jas_mean</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
    <span class="n">era5_jas_mean</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
    <span class="n">era5_jas_mean</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;cmo.thermal&quot;</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ERA5 Mean Temperature (1979-2006)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>

<span class="c1"># CESM mean</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">im2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
    <span class="n">cesm_jas_mean</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
    <span class="n">cesm_jas_mean</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
    <span class="n">cesm_jas_mean</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;cmo.thermal&quot;</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CESM Mean Temperature (1979-2006)&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>

<span class="c1"># Error (CESM - ERA5)</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">im3</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
    <span class="n">error</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
    <span class="n">error</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
    <span class="n">error</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">make_cb_range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;cmo.balance&quot;</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Error: CESM - ERA5&quot;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>

<span class="c1"># Shared colorbar for ERA5 and CESM (left side)</span>
<span class="n">cbar_ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>  <span class="c1"># [left, bottom, width, height]</span>
<span class="n">cbar1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax1</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<span class="n">cbar1</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Temperature (°C)&quot;</span><span class="p">)</span>

<span class="c1"># Separate colorbar for error (right side)</span>
<span class="n">cbar_ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>  <span class="c1"># [left, bottom, width, height]</span>
<span class="n">cbar2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im3</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax2</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<span class="n">cbar2</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Temperature Difference (°C)&quot;</span><span class="p">)</span>

<span class="c1"># ## save to file</span>
<span class="c1"># fig.savefig(&quot;figs/spatial-bias.svg&quot;)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2c4d4771566f69e4dd76585115be03b539344510dc5f344e4356f8a55cf4cfcd.png" src="../../_images/2c4d4771566f69e4dd76585115be03b539344510dc5f344e4356f8a55cf4cfcd.png" />
</div>
</div>
<p>The mean temperature plots look fairly similar; however, the error plot reveals some differences between the datasets.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SST bias vs <span class="math notranslate nohighlight">\(T_{2m}\)</span> bias
The magnitude and spatial structure of the bias differs between (i) data loaded from the CMIP server and (ii) data loaded from the cloud (SST data is not available for CESM2 on the AWS server, so we use 2-meter atmospheric temperature instead). If you are able to try both 2m-temperature and SST, it may be worth comparing them.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To-do (optional)
If you’re focusing on a different region, what does the spatial structure of the bias look like?</p>
</div>
</section>
<section id="histogram-of-gridcell-level-bias">
<h3>4. Histogram of gridcell-level bias<a class="headerlink" href="#histogram-of-gridcell-level-bias" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define Cape Cod region (similar to Woods Hole but slightly larger)</span>
<span class="c1"># Cape Cod roughly: lon 287-295, lat 40-43</span>
<span class="n">wh_lon</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">287.5</span><span class="p">,</span> <span class="mf">293.5</span><span class="p">)</span>
<span class="n">wh_lat</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">39</span><span class="p">,</span> <span class="mi">44</span><span class="p">)</span>

<span class="c1"># Extract Cape Cod subset</span>
<span class="n">error_wh</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="n">wh_lon</span><span class="p">,</span> <span class="n">latitude</span><span class="o">=</span><span class="n">wh_lat</span><span class="p">)</span>

<span class="c1"># Flatten both datasets</span>
<span class="n">error_flat</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">error_wh_flat</span> <span class="o">=</span> <span class="n">error_wh</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># Remove NaN values</span>
<span class="n">error_flat</span> <span class="o">=</span> <span class="n">error_flat</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error_flat</span><span class="p">)]</span>
<span class="n">error_wh_flat</span> <span class="o">=</span> <span class="n">error_wh_flat</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error_wh_flat</span><span class="p">)]</span>

<span class="c1"># Create bin edges for both histograms (use same range for comparison)</span>
<span class="n">all_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">error_flat</span><span class="p">,</span> <span class="n">error_wh_flat</span><span class="p">])</span>
<span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">all_errors</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">all_errors</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">50</span><span class="p">)</span>

<span class="c1"># Compute PDFs using your get_empirical_pdf function</span>
<span class="n">error_pdf</span><span class="p">,</span> <span class="n">error_edges</span> <span class="o">=</span> <span class="n">get_empirical_pdf</span><span class="p">(</span><span class="n">error_flat</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>
<span class="n">error_wh_pdf</span><span class="p">,</span> <span class="n">error_wh_edges</span> <span class="o">=</span> <span class="n">get_empirical_pdf</span><span class="p">(</span><span class="n">error_wh_flat</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>

<span class="c1"># Compute Gaussian fits</span>
<span class="n">error_gauss</span><span class="p">,</span> <span class="n">error_gauss_pts</span> <span class="o">=</span> <span class="n">get_gaussian_best_fit</span><span class="p">(</span><span class="n">error_flat</span><span class="p">)</span>
<span class="n">error_cape_cod_gauss</span><span class="p">,</span> <span class="n">error_cape_cod_gauss_pts</span> <span class="o">=</span> <span class="n">get_gaussian_best_fit</span><span class="p">(</span><span class="n">error_wh_flat</span><span class="p">)</span>

<span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot 1: Whole Region</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">stairs</span><span class="p">(</span>
    <span class="n">values</span><span class="o">=</span><span class="n">error_pdf</span><span class="p">,</span>
    <span class="n">edges</span><span class="o">=</span><span class="n">error_edges</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Whole Region&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">error_gauss_pts</span><span class="p">,</span> <span class="n">error_gauss</span><span class="p">,</span> <span class="s2">&quot;b--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gaussian Fit&quot;</span>
<span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature Error (°C)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Error Distribution: Whole Region (CESM - ERA5)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Plot 2: Cape Cod Region</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">stairs</span><span class="p">(</span>
    <span class="n">values</span><span class="o">=</span><span class="n">error_wh_pdf</span><span class="p">,</span>
    <span class="n">edges</span><span class="o">=</span><span class="n">error_wh_edges</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cape Cod Region&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">error_cape_cod_gauss_pts</span><span class="p">,</span>
    <span class="n">error_cape_cod_gauss</span><span class="p">,</span>
    <span class="s2">&quot;r--&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gaussian Fit&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature Error (°C)&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Error Distribution: Cape Cod Region (CESM - ERA5)&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1d846b29b2158909be94332706ea47fb46effd5f31964283599d33c670f59c0e.png" src="../../_images/1d846b29b2158909be94332706ea47fb46effd5f31964283599d33c670f59c0e.png" />
</div>
</div>
<p>What do you think are reasons for the bias? Try plotting the data set without applying the contours (ie make a more simple plot than we did above–you can use xarray’s built in plotting command ds.plot() )</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./pages/model_validation"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="overview.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">2) Model validation</p>
      </div>
    </a>
    <a class="right-next"
       href="../single_model/overview.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">3) Single-model climate-change</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">Data loading</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions">Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#for-loading-from-cloud">for loading from cloud</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#for-loading-from-server">for loading from server</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#utilities">utilities</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-handling">Data-handling</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#do-the-data-loading">Do the data-loading</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis">Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timeseries-of-t-wh">1. Timeseries of <span class="math notranslate nohighlight">\(T_{wh}\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#histogram-of-t-wh">2. Histogram of <span class="math notranslate nohighlight">\(T_{wh}\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-bias">3. Spatial bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#histogram-of-gridcell-level-bias">4. Histogram of gridcell-level bias</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Theo Carr & Finn Wimberly
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>